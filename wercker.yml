box: wercker/ruby
build:
  steps:
    - script:
        name: make ~/.ssh
        code: mkdir -p $HOME/.ssh
    - create-file:
        name: put private key
        filename: $HOME/.ssh/id_rsa
        overrite: true
        hide-from-log: true
        content: $SSH_KEY_PRIVATE
    - script:
        name: chmod id_rsa
        code: chmod 600 $HOME/.ssh/id_rsa
    - create-file:
        name: put tugboat config
        filename: $HOME/.tugboat
        overrite: true
        hide-from-log: true
        content: $TUGBOAT_CONFIG
    - script:
        name: install tugboat
        code: sudo gem install tugboat --no-ri --no-rdoc
    - script:
        name: define droplet name
        code: export DROPLET=wercker-infrataster-$(date +%s)
    - script:
        name: write droplet name to a file
        code: echo $DROPLET > /tmp/droplet
    - script:
        name: create droplet
        code: tugboat create --size=63 --image=3375742 --region=6 $DROPLET
    - script:
        name: wait droplet
        code: timeout 180 tugboat wait $DROPLET
    - script:
        name: get ipaddress
        code: export IPADDRESS=$(./ci/get_droplet_ip $DROPLET)
    - script:
        name: wait 10 sec
        code: sleep 10
    - script:
        name: rsync source
        code: rsync -a -e "ssh -o 'StrictHostKeyChecking no'" . root@$IPADDRESS:~/src
    - script:
        name: run test script
        code: ssh -o 'StrictHostKeyChecking no' root@$IPADDRESS 'cd src && bash -x ./ci/test.bash'
  after-steps:
    - script:
        name: destory droplet
        code: tugboat destroy -c $(cat /tmp/droplet)



